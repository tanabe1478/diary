# 依存ライブラリの更新

> **作成日**: 2025-12-23
> **対象ブランチ**: `refactor/update-dependencies`

## 目的

古い依存ライブラリを最新版に更新し、セキュリティ脆弱性を解消する。テストで保護された状態で安全に更新を行う。

## 背景

`npm outdated`の結果、以下のライブラリが古いバージョンになっている：

### マイナー/パッチアップデート（影響小）

- `date-fns`: 2.30.0 → 4.1.0
- `glob`: 7.2.3 → 13.0.0
- `marked`: 12.0.2 → 17.0.1
- `remark`: 14.0.3 → 15.0.1
- `remark-gfm`: 3.0.1 → 4.0.1
- `remark-github`: 11.2.4 → 12.0.0
- `remark-parse`: 10.0.2 → 11.0.0
- `remark-rehype`: 10.1.0 → 11.1.2
- `rehype-stringify`: 9.0.4 → 10.0.1
- `unified`: 10.1.2 → 11.0.5

### メジャーバージョンアップデート（影響大、慎重に）

- `react`: 18.3.1 → 19.2.3
- `react-dom`: 18.3.1 → 19.2.3
- `next`: 15.5.9 → 16.1.1

## アプローチ

### フェーズ 1: マイナー/パッチアップデート

影響が小さいライブラリから順次更新。各更新後にテストを実行して動作確認。

### フェーズ 2: メジャーバージョンアップデート

React 19 と Next.js 16 は破壊的変更がある可能性があるため、慎重に更新。

- まず React 19 の変更点を確認
- Next.js 16 の変更点を確認
- 必要に応じてコードを修正

### フェーズ 3: 動作確認

- すべてのテストが通ることを確認
- ビルドが成功することを確認
- 開発サーバーが起動することを確認

## タスクリスト

### 準備

- [x] 実装計画の作成
- [ ] ブランチ作成: `refactor/update-dependencies`
- [ ] 現在のテストがすべて通ることを確認

### フェーズ 1: マイナー/パッチアップデート

- [ ] Markdown 処理ライブラリの更新
  - `remark`, `remark-gfm`, `remark-github`, `remark-parse`, `remark-rehype`
  - `rehype-stringify`, `unified`
- [ ] テストを実行して動作確認
- [ ] ユーティリティライブラリの更新
  - `date-fns`, `glob`, `marked`
- [ ] テストを実行して動作確認

### フェーズ 2: メジャーバージョンアップデート（オプション）

- [ ] React 19 の変更点を調査
- [ ] Next.js 16 の変更点を調査
- [ ] 必要に応じてコード修正
- [ ] React/React DOM を 19.x に更新
- [ ] テストを実行して動作確認
- [ ] Next.js を 16.x に更新
- [ ] テストを実行して動作確認

### 最終確認

- [ ] すべてのテストが通る（14 テスト）
- [ ] `npm run build`が成功する
- [ ] `npm run dev`で開発サーバーが起動する
- [ ] `npm run lint`でエラーがない
- [ ] `npm run typecheck`で型エラーがない

### ドキュメント

- [ ] 実装メモの作成
- [ ] package.json の変更内容を記録

### 仕上げ

- [ ] コミット & プッシュ
- [ ] PR 作成

## 技術的考慮事項

### date-fns のメジャーアップデート (v2 → v4)

- v3 で ESM への移行
- v4 で TypeScript の強化
- `format`関数の API は互換性あり
- **対応**: テストで動作確認のみで OK

### glob v7 → v13

- API の大幅な変更
- 現在は`glob-promise`を使用しているため影響は限定的
- **対応**: テストで動作確認

### remark/rehype 系のアップデート

- unified v11 で ESM 対応が強化
- remark と rehype のプラグインも連動して更新
- **対応**: すべてまとめて更新し、テストで動作確認

### React 19 のメジャーアップデート

- 新機能: Server Components、Server Actions、useOptimistic 等
- 破壊的変更の可能性
- **対応**: まず調査し、影響を確認してから更新
- **リスク**: 高

### Next.js 16 のメジャーアップデート

- React 19 が必要
- 新しい App Router 機能
- **対応**: React 19 の後に更新
- **リスク**: 高

## リスク

1. **Markdown 処理の動作変更**: unified 系の更新で出力 HTML が変わる可能性
   - 対策: テストで既存の動作を確認、必要に応じてテストを調整

2. **React 19 の破壊的変更**: コンポーネントが動作しなくなる可能性
   - 対策: まず調査し、影響が大きければこの PR では見送り

3. **Next.js 16 の破壊的変更**: ビルドやルーティングが動作しなくなる可能性
   - 対策: まず調査し、影響が大きければこの PR では見送り

## 代替案

### 代替案 1: すべてを一度に更新

- すべてのライブラリを最新版に一括更新
- **却下理由**: リスクが高く、問題の切り分けが困難

### 代替案 2: マイナーアップデートのみ実施

- React 19 と Next.js 16 は見送り、他のライブラリのみ更新
- **採用**: まずこれを試し、React/Next.js は別 PR で対応

### 代替案 3: Dependabot で自動更新

- GitHub Dependabot を設定して自動 PR 作成
- **検討中**: 将来的に導入する

## 成功基準

### 最低限の成功基準

- [ ] マイナー/パッチアップデートが完了
- [ ] すべてのテスト（14 テスト）が通る
- [ ] ビルドが成功する

### 理想的な成功基準

- [ ] React 19、Next.js 16 を含むすべてが最新版
- [ ] すべてのテストが通る
- [ ] パフォーマンスが向上している

## 次のステップ（この PR 後）

1. GitHub Actions での Dependabot 設定
2. gialog 依存の除去
3. 定期的な依存関係の更新プロセスの確立

---

**関連ドキュメント**:

- [CLAUDE.md](../../CLAUDE.md)
- [開発ワークフロー](../workflow.md)
- [テストインフラ実装](../../docs/implementations/2025-12-23_add-testing-infrastructure.md)
